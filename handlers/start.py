from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, Document, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from config import START_MESSAGE, HELP_MESSAGE, ABOUT_MESSAGE, ADMIN_ID
from utils.keyboards import get_start_keyboard, get_source_selection_keyboard
import logging
import os
import re

router = Router()
logger = logging.getLogger(__name__)

COOKIES_PATH = "/opt/telegram-cover-bot/youtube_cookies.txt"


class CookiesStates(StatesGroup):
    waiting_for_cookies = State()


def parse_cookies_text(text: str) -> str:
    """Parse cookies from text (ytdlnis/Netscape format) and return valid Netscape cookie file content."""
    lines = text.strip().split('\n')
    cookie_lines = []

    for line in lines:
        line = line.strip()
        if not line or line.startswith('#'):
            continue

        # Split by tab or multiple spaces
        parts = re.split(r'\t+', line)
        if len(parts) < 7:
            # Try splitting by spaces (ytdlnis format)
            parts = re.split(r'\s+', line, maxsplit=6)

        if len(parts) < 7:
            continue

        domain = parts[0]
        # Validate it looks like a cookie line
        if not ('youtube.com' in domain or 'google' in domain or 'doubleclick' in domain):
            continue

        # Reconstruct as tab-separated
        cookie_lines.append('\t'.join(parts[:7]))

    if not cookie_lines:
        return ""

    header = "# Netscape HTTP Cookie File\n# This file is generated by yt-dlp. Do not edit.\n\n"
    return header + '\n'.join(cookie_lines) + '\n'


@router.message(Command("start"))
async def cmd_start(message: Message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start"""
    await message.answer(
        START_MESSAGE,
        reply_markup=get_start_keyboard(),
        parse_mode="Markdown"
    )

@router.message(Command("help"))
async def cmd_help(message: Message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /help"""
    await message.answer(
        HELP_MESSAGE,
        parse_mode="Markdown"
    )

@router.message(Command("about"))
async def cmd_about(message: Message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /about"""
    await message.answer(
        ABOUT_MESSAGE,
        parse_mode="Markdown"
    )

@router.callback_query(F.data == "start_search")
async def callback_start_search(callback: CallbackQuery):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ 'ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞº'"""
    await callback.message.edit_text(
        "ğŸµ **ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞºĞ° Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ñ**\n\n"
        "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:\n"
        "â€¢ Imagine Dragons Believer\n"
        "â€¢ Coldplay\n"
        "â€¢ The Beatles Yesterday\n"
        "â€¢ Eminem Lose Yourself\n\n"
        "ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°.",
        parse_mode="Markdown"
    )
    await callback.answer()

@router.callback_query(F.data == "new_search")
async def callback_new_search(callback: CallbackQuery):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ 'ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº'"""
    await callback.message.edit_text(
        "ğŸµ **ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞºĞ° Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ñ**\n\n"
        "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:\n"
        "â€¢ Imagine Dragons Believer\n"
        "â€¢ Coldplay\n"
        "â€¢ The Beatles Yesterday\n"
        "â€¢ Eminem Lose Yourself\n\n"
        "ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°.",
        parse_mode="Markdown"
    )
    await callback.answer()

@router.callback_query(F.data == "help")
async def callback_help(callback: CallbackQuery):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ 'ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ'"""
    await callback.message.answer(
        HELP_MESSAGE,
        parse_mode="Markdown"
    )
    await callback.answer()

@router.callback_query(F.data == "noop")
async def callback_noop(callback: CallbackQuery):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ğ±ĞµĞ· Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹)"""
    await callback.answer()

@router.message(Command("upload_cookies", "auth_youtube", "cookies"))
async def cmd_upload_cookies(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /upload_cookies, /auth_youtube, /cookies"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="ğŸ“‹ Ğ’ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ cookies Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼",
            callback_data="cookies_paste_text"
        )],
        [InlineKeyboardButton(
            text="ğŸ“– Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ (yt-dlp wiki)",
            url="https://github.com/yt-dlp/yt-dlp/wiki/Extractors#exporting-youtube-cookies"
        )],
        [InlineKeyboardButton(
            text="ğŸ”— Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Chrome",
            url="https://chromewebstore.google.com/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc"
        )],
        [InlineKeyboardButton(
            text="ğŸ¦Š Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Firefox",
            url="https://addons.mozilla.org/en-US/firefox/addon/cookies-txt/"
        )]
    ])

    await message.answer(
        "ğŸª **ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ YouTube cookies**\n\n"
        "Cookies Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ¸ Ğ¼ÑƒĞ·Ñ‹ĞºĞ¸ Ñ YouTube.\n\n"
        "**Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 1 â€” Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ¼ (Ğ¸Ğ· ytdlnis Ğ¸ Ğ´Ñ€.):**\n"
        "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ Ğ¸ Ğ²ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ cookies Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼\n\n"
        "**Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 2 â€” Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ¼ (Ğ¸Ğ· Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°):**\n"
        "1. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°\n"
        "2. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ YouTube Ğ¸ Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚\n"
        "3. Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ cookies Ğ² Ñ„Ğ°Ğ¹Ğ»\n"
        "4. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ°Ğ¹Ğ» `youtube_cookies.txt` Ğ¼Ğ½Ğµ\n\n"
        "ğŸ”’ Cookies Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ.",
        parse_mode="Markdown",
        reply_markup=keyboard,
        disable_web_page_preview=True
    )


@router.callback_query(F.data == "cookies_paste_text")
async def callback_cookies_paste(callback: CallbackQuery, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ 'Ğ’ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼'"""
    await state.set_state(CookiesStates.waiting_for_cookies)
    await callback.message.edit_text(
        "ğŸ“‹ **Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ cookies Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼**\n\n"
        "Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ cookies Ğ¸Ğ· ytdlnis Ğ¸Ğ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ "
        "Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼.\n\n"
        "Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (Netscape/tab-separated):\n"
        "`\\.youtube.com TRUE / TRUE 1234567890 NAME value`\n\n"
        "Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ /cancel",
        parse_mode="Markdown"
    )
    await callback.answer()


@router.message(Command("cancel"))
async def cmd_cancel(message: Message, state: FSMContext):
    """ĞÑ‚Ğ¼ĞµĞ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ"""
    current_state = await state.get_state()
    if current_state is None:
        return
    await state.clear()
    await message.answer("âŒ Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾.")


@router.message(CookiesStates.waiting_for_cookies)
async def handle_cookies_text(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ° cookies"""
    text = message.text
    if not text:
        await message.answer("âŒ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ cookies Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼, Ğ½Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ¼.\nĞ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹: /cancel")
        return

    status_msg = await message.answer("â³ ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ cookies...")

    try:
        cookie_content = parse_cookies_text(text)

        if not cookie_content:
            await status_msg.edit_text(
                "âŒ **ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ñ‚ÑŒ cookies**\n\n"
                "Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ Ñ‡Ñ‚Ğ¾ Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ YouTube cookies Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Netscape.\n"
                "Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹: /cancel",
                parse_mode="Markdown"
            )
            return

        # Count cookies
        cookie_count = len([l for l in cookie_content.split('\n') if l.strip() and not l.startswith('#')])

        # Save
        with open(COOKIES_PATH, 'w') as f:
            f.write(cookie_content)

        await state.clear()

        logger.info(f"Cookies updated via text by user {message.from_user.id}: {cookie_count} cookies")

        await status_msg.edit_text(
            f"âœ… **Cookies Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹!**\n\n"
            f"ğŸ“Š Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ cookies: {cookie_count}\n\n"
            f"ğŸ”„ Ğ‘Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· 2 ÑĞµĞºÑƒĞ½Ğ´Ñ‹...",
            parse_mode="Markdown"
        )

    except Exception as e:
        logger.error(f"Error saving cookies: {e}")
        try:
            await status_msg.edit_text(
                f"âŒ **ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ cookies**\n\n"
                f"`{str(e)}`",
                parse_mode="Markdown"
            )
        except Exception:
            pass
        return

    # Restart bot outside try/except to avoid catching ServerDisconnectedError
    import subprocess
    subprocess.Popen(['bash', '-c', 'sleep 2 && systemctl restart telegram-cover-bot'])


@router.message(F.document)
async def handle_document(message: Message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (cookies Ñ„Ğ°Ğ¹Ğ»Ğ°)"""
    document: Document = message.document

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°
    if not document.file_name or 'cookies' not in document.file_name.lower():
        return

    try:
        status_msg = await message.answer("â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ cookies Ñ„Ğ°Ğ¹Ğ»...")

        file = await message.bot.get_file(document.file_id)
        await message.bot.download_file(file.file_path, COOKIES_PATH)

        with open(COOKIES_PATH, 'r') as f:
            content = f.read()

        # Basic validation
        if 'youtube.com' not in content:
            await status_msg.edit_text(
                "âŒ **ĞÑˆĞ¸Ğ±ĞºĞ°:** Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ YouTube cookies.\n\n"
                "Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ²Ñ‹ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸ cookies Ñ ÑĞ°Ğ¹Ñ‚Ğ° YouTube.",
                parse_mode="Markdown"
            )
            os.remove(COOKIES_PATH)
            return

        cookie_count = len([l for l in content.split('\n') if l.strip() and not l.startswith('#')])

        logger.info(f"Cookies file uploaded by user {message.from_user.id}: {cookie_count} cookies")

        await status_msg.edit_text(
            f"âœ… **Cookies ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹!**\n\n"
            f"ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:\n"
            f"â€¢ Ğ¤Ğ°Ğ¹Ğ»: `{document.file_name}`\n"
            f"â€¢ Ğ Ğ°Ğ·Ğ¼ĞµÑ€: {document.file_size} Ğ±Ğ°Ğ¹Ñ‚\n"
            f"â€¢ Cookies: {cookie_count}\n\n"
            f"ğŸ”„ Ğ‘Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· 2 ÑĞµĞºÑƒĞ½Ğ´Ñ‹...",
            parse_mode="Markdown"
        )

    except Exception as e:
        logger.error(f"Error uploading cookies: {e}")
        try:
            await message.answer(
                f"âŒ **ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ cookies:**\n\n"
                f"`{str(e)}`",
                parse_mode="Markdown"
            )
        except Exception:
            pass
        return

    import subprocess
    subprocess.Popen(['bash', '-c', 'sleep 2 && systemctl restart telegram-cover-bot'])
