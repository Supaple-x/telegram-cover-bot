#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ YouTube –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ cookies
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç Playwright –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
"""

import json
import sys
from playwright.sync_api import sync_playwright
import time

def export_cookies_to_netscape(cookies, output_file):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç cookies –≤ —Ñ–æ—Ä–º–∞—Ç Netscape –¥–ª—è yt-dlp"""
    with open(output_file, 'w') as f:
        f.write("# Netscape HTTP Cookie File\n")
        f.write("# This file is generated by Playwright. Do not edit.\n\n")
        
        for cookie in cookies:
            domain = cookie.get('domain', '')
            flag = 'TRUE' if domain.startswith('.') else 'FALSE'
            path = cookie.get('path', '/')
            secure = 'TRUE' if cookie.get('secure', False) else 'FALSE'
            expiration = str(int(cookie.get('expires', -1)))
            name = cookie.get('name', '')
            value = cookie.get('value', '')
            
            f.write(f"{domain}\t{flag}\t{path}\t{secure}\t{expiration}\t{name}\t{value}\n")

def main():
    print("üöÄ –ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ YouTube...")
    print("=" * 60)
    
    with sync_playwright() as p:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –≤ headless=False —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –æ–∫–Ω–æ
        browser = p.chromium.launch(
            headless=False,
            args=[
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-blink-features=AutomationControlled'
            ]
        )
        
        context = browser.new_context(
            viewport={'width': 1280, 'height': 720},
            user_agent='Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        )
        
        page = context.new_page()
        
        print("üì± –û—Ç–∫—Ä—ã–≤–∞–µ–º YouTube...")
        page.goto('https://www.youtube.com', wait_until='networkidle')
        
        print("\n" + "=" * 60)
        print("‚ö†Ô∏è  –í–ê–ñ–ù–û: –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ YouTube —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä!")
        print("=" * 60)
        print("\n1. –í –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ '–í–æ–π—Ç–∏'")
        print("2. –í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å Google")
        print("3. –ü—Ä–æ–π–¥–∏—Ç–µ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
        print("4. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã YouTube")
        print("5. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª")
        print("\n" + "=" * 60)
        
        input("\n‚úÖ –ù–∞–∂–º–∏—Ç–µ Enter –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª–∏—Å—å –≤ YouTube...")
        
        print("\nüîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...")
        time.sleep(2)
        
        # –ü–æ–ª—É—á–∞–µ–º cookies
        cookies = context.cookies()
        
        if not cookies:
            print("‚ùå –û—à–∏–±–∫–∞: Cookies –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
            browser.close()
            sys.exit(1)
        
        print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(cookies)} cookies")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ Netscape –¥–ª—è yt-dlp
        output_file = '/opt/telegram-cover-bot/youtube_cookies.txt'
        export_cookies_to_netscape(cookies, output_file)
        
        print(f"\n‚úÖ Cookies —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {output_file}")
        print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"   - –í—Å–µ–≥–æ cookies: {len(cookies)}")
        print(f"   - –î–æ–º–µ–Ω: youtube.com")
        
        # –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSON –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        json_file = '/opt/telegram-cover-bot/youtube_cookies.json'
        with open(json_file, 'w') as f:
            json.dump(cookies, f, indent=2)
        print(f"   - JSON backup: {json_file}")
        
        print("\nüéâ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:")
        print("   systemctl restart telegram-cover-bot")
        
        browser.close()

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n‚ùå –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(1)
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
